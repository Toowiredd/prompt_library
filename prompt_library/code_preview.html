        <html>
        <head>
            <style>

            </style>
        </head>

        <body>

            <html>
                <head>
                    <style>
                        pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: #ffffcc }
.highlight { background: #f8f8f8; }
.highlight .c { color: #3D7B7B; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #FF0000 } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .ch { color: #3D7B7B; font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: #3D7B7B; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #9C6500 } /* Comment.Preproc */
.highlight .cpf { color: #3D7B7B; font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: #3D7B7B; font-style: italic } /* Comment.Single */
.highlight .cs { color: #3D7B7B; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .ges { font-weight: bold; font-style: italic } /* Generic.EmphStrong */
.highlight .gr { color: #E40000 } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #008400 } /* Generic.Inserted */
.highlight .go { color: #717171 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #0044DD } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #BA2121 } /* Literal.String */
.highlight .na { color: #687822 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #AA22FF } /* Name.Decorator */
.highlight .ni { color: #717171; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #CB3F38; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #0000FF } /* Name.Function */
.highlight .nl { color: #767600 } /* Name.Label */
.highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #666666 } /* Literal.Number.Bin */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sa { color: #BA2121 } /* Literal.String.Affix */
.highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
.highlight .sc { color: #BA2121 } /* Literal.String.Char */
.highlight .dl { color: #BA2121 } /* Literal.String.Delimiter */
.highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #BA2121 } /* Literal.String.Double */
.highlight .se { color: #AA5D1F; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
.highlight .si { color: #A45A77; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #A45A77 } /* Literal.String.Regex */
.highlight .s1 { color: #BA2121 } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .fm { color: #0000FF } /* Name.Function.Magic */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .vm { color: #19177C } /* Name.Variable.Magic */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */
                        body { background: white; padding: 20px; }
                        h3 { color: #333; }
                    </style>
                </head>
                <body><h3>api.ts</h3><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * HTTP API for prompt library</span>
<span class="cm"> * Last Updated: 2025-02-08 11:02:29</span>
<span class="cm"> * @author Toowiredd</span>
<span class="cm"> */</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Hono</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;npm:hono&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">timing</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;npm:hono/timing&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">cors</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;npm:hono/cors&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PromptDatabase</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;./database&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PromptExecutor</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;./executor&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PromptTemplateSchema</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;./types&quot;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Hono</span><span class="p">();</span>

<span class="c1">// Middleware</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">timing</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">cors</span><span class="p">());</span>

<span class="c1">// Error handler</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">onError</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span><span class="si">}</span><span class="sb">] Error:`</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="kt">err.code</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;INTERNAL_ERROR&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">err.message</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="mf">500</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Routes</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/templates/:category?&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">templates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">PromptDatabase</span><span class="p">.</span><span class="nx">listTemplates</span><span class="p">(</span><span class="nx">category</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">templates</span><span class="w"> </span><span class="p">});</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/templates&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">PromptTemplateSchema</span><span class="p">.</span><span class="nx">parseAsync</span><span class="p">(</span><span class="nx">body</span><span class="p">);</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">PromptDatabase</span><span class="p">.</span><span class="nx">createTemplate</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="mf">201</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;VALIDATION_ERROR&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Invalid template format&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">error.errors</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">400</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/execute/:templateId&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">templateId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s2">&quot;templateId&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">executor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PromptExecutor</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">OPENAI_API_KEY</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">executor</span><span class="p">.</span><span class="nx">execute</span><span class="p">({</span>
<span class="w">    </span><span class="nx">templateId</span><span class="p">,</span>
<span class="w">    </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="kt">body.parameters</span><span class="p">,</span>
<span class="w">    </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">requestId</span><span class="o">:</span><span class="w"> </span><span class="kt">c.req.headers.get</span><span class="p">(</span><span class="s2">&quot;x-request-id&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="sb">`req_</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">    </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">c.req.headers.get</span><span class="p">(</span><span class="s2">&quot;x-user-id&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;anonymous&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">body.metadata</span><span class="p">,</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/executions/:templateId&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">templateId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s2">&quot;templateId&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">))</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">10</span><span class="p">;</span>
<span class="w">  </span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">executions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">PromptDatabase</span><span class="p">.</span><span class="nx">getExecutions</span><span class="p">(</span><span class="nx">templateId</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">executions</span><span class="w"> </span><span class="p">});</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">app</span><span class="p">;</span>
</pre></div>
<h3>architectural_chain_executor.ts</h3><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">EventEmitter</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;events&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">ArchitecturalAnalysisResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">;</span>
<span class="w">  </span><span class="nx">metrics</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">confidence</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">completeness</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">impactScore</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">AnalysisContext</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">codebase</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">previousResults</span><span class="o">:</span><span class="w"> </span><span class="kt">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">ArchitecturalAnalysisResult</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">repositorySize</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">primaryLanguage</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">analysisDepth</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;surface&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;detailed&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;comprehensive&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">ArchitecturalChainExecutor</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">EventEmitter</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">AnalysisContext</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">stages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s1">&#39;1_api_surface_analysis&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;2_dependency_graph_analysis&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;3_architectural_pattern_analysis&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;4_scaling_analysis&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;5_integration_surface_analysis&#39;</span>
<span class="w">  </span><span class="p">];</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">codebase</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">AnalysisContext</span><span class="p">[</span><span class="s1">&#39;metadata&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">super</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">codebase</span><span class="p">,</span>
<span class="w">      </span><span class="nx">previousResults</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">metadata</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">executeStage</span><span class="p">(</span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ArchitecturalAnalysisResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">();</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Emit start event for monitoring</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;stageStart&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">startTime</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">analyzeStage</span><span class="p">(</span><span class="nx">stage</span><span class="p">);</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">analysisResult</span><span class="o">:</span><span class="w"> </span><span class="kt">ArchitecturalAnalysisResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">stage</span><span class="p">,</span>
<span class="w">        </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">result</span><span class="p">,</span>
<span class="w">        </span><span class="nx">metrics</span><span class="o">:</span><span class="w"> </span><span class="kt">this.calculateMetrics</span><span class="p">(</span><span class="nx">result</span><span class="p">)</span>
<span class="w">      </span><span class="p">};</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">previousResults</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="nx">analysisResult</span><span class="p">);</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;stageComplete&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">analysisResult</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">analysisResult</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;stageError&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="p">});</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">calculateMetrics</span><span class="p">(</span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">ArchitecturalAnalysisResult</span><span class="p">[</span><span class="s1">&#39;metrics&#39;</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Implement metric calculation based on result completeness and quality</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">confidence</span><span class="o">:</span><span class="w"> </span><span class="kt">0.8</span><span class="p">,</span>
<span class="w">      </span><span class="nx">completeness</span><span class="o">:</span><span class="w"> </span><span class="kt">0.9</span><span class="p">,</span>
<span class="w">      </span><span class="nx">impactScore</span><span class="o">:</span><span class="w"> </span><span class="kt">0.7</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">analyzeStage</span><span class="p">(</span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Implement the actual analysis logic for each stage</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;Analysis implementation required&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">execute</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nb">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">ArchitecturalAnalysisResult</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">stages</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">executeStage</span><span class="p">(</span><span class="nx">stage</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">previousResults</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="nx">getAnalysisContext</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nx">AnalysisContext</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">...</span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">ArchitecturalChainExecutor</span><span class="p">,</span>
<span class="w">  </span><span class="nx">ArchitecturalAnalysisResult</span><span class="p">,</span>
<span class="w">  </span><span class="nx">AnalysisContext</span>
<span class="p">};</span>
</pre></div>
<h3>chain_executor.ts</h3><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PromptChainValidator</span><span class="p">,</span><span class="w"> </span><span class="nx">PromptResponse</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;./prompt_chain_validator&#39;</span><span class="p">;</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">ChainContext</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">codeContent</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">previousResults</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">any</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">ChainExecutor</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">ChainContext</span><span class="p">;</span>
<span class="w">  </span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">codeContent</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">codeContent</span><span class="p">,</span>
<span class="w">      </span><span class="nx">previousResults</span><span class="o">:</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">executeStage</span><span class="p">(</span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">prompt</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">PromptResponse</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Replace variables in prompt</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">processedPrompt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">processPromptVariables</span><span class="p">(</span><span class="nx">prompt</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Execute the prompt (implementation depends on your LLM integration)</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">executeLLMPrompt</span><span class="p">(</span><span class="nx">processedPrompt</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="c1">// Validate the response</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">PromptChainValidator</span><span class="p">.</span><span class="nx">validateChainResponse</span><span class="p">(</span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="nx">response</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">processPromptVariables</span><span class="p">(</span><span class="nx">prompt</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">prompt</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\${([^}]+)}/g</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">match</span><span class="p">,</span><span class="w"> </span><span class="nx">variable</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">variable</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;CODE_CONTENT&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">codeContent</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">previousResults</span><span class="p">[</span><span class="nx">variable</span><span class="p">]</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">match</span><span class="p">;</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">executeLLMPrompt</span><span class="p">(</span><span class="nx">prompt</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Implement your LLM integration here</span>
<span class="w">    </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s1">&#39;LLM integration not implemented&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">execute</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">PromptResponse</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">PromptResponse</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">stage</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;1_initial_analysis&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;2_complexity_assessment&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;3_improvement_ideation&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;4_refactoring_plan&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;5_implementation_guidance&#39;</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">executeStage</span><span class="p">(</span><span class="nx">stage</span><span class="p">,</span><span class="w"> </span><span class="cm">/* get prompt for stage */</span><span class="p">);</span>
<span class="w">      </span><span class="nx">results</span><span class="p">[</span><span class="nx">stage</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="p">;</span>
<span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">previousResults</span><span class="p">[</span><span class="nx">stage</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
<span class="w">      </span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">status</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">results</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ChainExecutor</span><span class="w"> </span><span class="p">};</span>
</pre></div>
<h3>database.ts</h3><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Database schema and operations for prompt library</span>
<span class="cm"> * Last Updated: 2025-02-08 11:02:29</span>
<span class="cm"> * @author Toowiredd</span>
<span class="cm"> */</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">drizzle</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;npm:drizzle-orm/libsql&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">  </span><span class="nx">sqliteTable</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="nx">text</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="nx">integer</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="nx">primaryKey</span><span class="w"> </span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;npm:drizzle-orm/sqlite-core&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sql</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;npm:drizzle-orm&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sqlite</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;https://esm.town/v/std/sqlite&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PromptTemplate</span><span class="p">,</span><span class="w"> </span><span class="nx">PromptExecutionResult</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;./types&quot;</span><span class="p">;</span>

<span class="c1">// Schema definitions</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">templates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sqliteTable</span><span class="p">(</span><span class="s2">&quot;prompt_templates&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">).</span><span class="nx">primaryKey</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;template&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;parameters&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span><span class="w"> </span><span class="c1">// JSON string</span>
<span class="w">  </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">author</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;author&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">lastUpdated</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;last_updated&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span><span class="w"> </span><span class="c1">// JSON string</span>
<span class="w">  </span><span class="nx">createdAt</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;created_at&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">notNull</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="k">default</span><span class="p">(</span><span class="nx">sql</span><span class="sb">`CURRENT_TIMESTAMP`</span><span class="p">),</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">executions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sqliteTable</span><span class="p">(</span><span class="s2">&quot;prompt_executions&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">).</span><span class="nx">primaryKey</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">templateId</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;template_id&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="nx">notNull</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="nx">references</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">templates</span><span class="p">.</span><span class="nx">id</span><span class="p">),</span>
<span class="w">  </span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span><span class="w"> </span><span class="c1">// JSON string</span>
<span class="w">  </span><span class="nx">output</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span><span class="w"> </span><span class="c1">// JSON string</span>
<span class="w">  </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">executionTime</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="p">(</span><span class="s2">&quot;execution_time&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="p">(</span><span class="s2">&quot;success&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">),</span><span class="w"> </span><span class="c1">// JSON string</span>
<span class="w">  </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">),</span><span class="w"> </span><span class="c1">// JSON string</span>
<span class="p">});</span>

<span class="c1">// Initialize database</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drizzle</span><span class="p">(</span><span class="nx">sqlite</span><span class="p">);</span>

<span class="c1">// Database operations</span>
<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PromptDatabase</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">createTemplate</span><span class="p">(</span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">PromptTemplate</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">template</span><span class="p">.</span><span class="nx">category</span><span class="si">}</span><span class="sb">_</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">templates</span><span class="p">).</span><span class="nx">values</span><span class="p">({</span>
<span class="w">      </span><span class="nx">id</span><span class="p">,</span>
<span class="w">      </span><span class="p">...</span><span class="nx">template</span><span class="p">,</span>
<span class="w">      </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">parameters</span><span class="p">),</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">metadata</span><span class="p">),</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">id</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">getTemplate</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">PromptTemplate</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span>
<span class="w">      </span><span class="p">.</span><span class="nx">select</span><span class="p">()</span>
<span class="w">      </span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">templates</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">sql</span><span class="sb">`id = </span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">get</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">...</span><span class="nx">result</span><span class="p">,</span>
<span class="w">      </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">parameters</span><span class="p">),</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">metadata</span><span class="p">),</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">listTemplates</span><span class="p">(</span><span class="nx">category?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">select</span><span class="p">().</span><span class="kr">from</span><span class="p">(</span><span class="nx">templates</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">category</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">query</span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">sql</span><span class="sb">`category = </span><span class="si">${</span><span class="nx">category</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">query</span><span class="p">.</span><span class="nx">all</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">result</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">      </span><span class="p">...</span><span class="nx">result</span><span class="p">,</span>
<span class="w">      </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">parameters</span><span class="p">),</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">metadata</span><span class="p">),</span>
<span class="w">    </span><span class="p">}));</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">logExecution</span><span class="p">(</span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">PromptExecutionResult</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">executions</span><span class="p">).</span><span class="nx">values</span><span class="p">({</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">result.id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">templateId</span><span class="o">:</span><span class="w"> </span><span class="kt">result.templateId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">input</span><span class="p">),</span>
<span class="w">      </span><span class="nx">output</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">output</span><span class="p">),</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">result.timestamp</span><span class="p">,</span>
<span class="w">      </span><span class="nx">executionTime</span><span class="o">:</span><span class="w"> </span><span class="kt">result.executionTime</span><span class="p">,</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">result.success</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">result.error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">result.metadata</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">metadata</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">getExecutions</span><span class="p">(</span><span class="nx">templateId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span>
<span class="w">      </span><span class="p">.</span><span class="nx">select</span><span class="p">()</span>
<span class="w">      </span><span class="p">.</span><span class="kr">from</span><span class="p">(</span><span class="nx">executions</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">where</span><span class="p">(</span><span class="nx">sql</span><span class="sb">`template_id = </span><span class="si">${</span><span class="nx">templateId</span><span class="si">}</span><span class="sb">`</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="nx">limit</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">orderBy</span><span class="p">(</span><span class="nx">sql</span><span class="sb">`timestamp DESC`</span><span class="p">)</span>
<span class="w">      </span><span class="p">.</span><span class="nx">all</span><span class="p">();</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">result</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">      </span><span class="p">...</span><span class="nx">result</span><span class="p">,</span>
<span class="w">      </span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">input</span><span class="p">),</span>
<span class="w">      </span><span class="nx">output</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">output</span><span class="p">),</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">result.error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">result.metadata</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">metadata</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">    </span><span class="p">}));</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h3>executor.ts</h3><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Prompt execution engine</span>
<span class="cm"> * Last Updated: 2025-02-08 11:02:29</span>
<span class="cm"> * @author Toowiredd</span>
<span class="cm"> */</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">OpenAI</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;npm:openai&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PromptDatabase</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;./database&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">  </span><span class="kr">type</span><span class="w"> </span><span class="nx">PromptExecutionContext</span><span class="p">,</span>
<span class="w">  </span><span class="kr">type</span><span class="w"> </span><span class="nx">PromptExecutionResult</span><span class="p">,</span>
<span class="w">  </span><span class="kr">type</span><span class="w"> </span><span class="nx">PromptTemplate</span><span class="p">,</span>
<span class="w">  </span><span class="nx">PromptTemplateSchema</span><span class="w"> </span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;./types&quot;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">PromptExecutor</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">openai</span><span class="o">:</span><span class="w"> </span><span class="kt">OpenAI</span><span class="p">;</span>
<span class="w">  </span>
<span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="nx">apiKey</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">openai</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">OpenAI</span><span class="p">({</span><span class="w"> </span><span class="nx">apiKey</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">validateTemplate</span><span class="p">(</span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">PromptTemplate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">PromptTemplateSchema</span><span class="p">.</span><span class="nx">parseAsync</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s2">&quot;Template validation failed:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">processTemplate</span><span class="p">(</span>
<span class="w">    </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">PromptTemplate</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">processedTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">template</span><span class="p">.</span><span class="nx">template</span><span class="p">;</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">parameters</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">template</span><span class="p">.</span><span class="nx">parameters</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Unknown parameter: </span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="nx">processedTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">processedTemplate</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span>
<span class="w">        </span><span class="sb">`\${</span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">}`</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="nb">String</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
<span class="w">      </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">processedTemplate</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">execute</span><span class="p">(</span>
<span class="w">    </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">PromptExecutionContext</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">PromptExecutionResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">executionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`exec_</span><span class="si">${</span><span class="nx">context</span><span class="p">.</span><span class="nx">requestId</span><span class="si">}</span><span class="sb">_</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Fetch template</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">PromptDatabase</span><span class="p">.</span><span class="nx">getTemplate</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">templateId</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">template</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Template </span><span class="si">${</span><span class="nx">context</span><span class="p">.</span><span class="nx">templateId</span><span class="si">}</span><span class="sb"> not found`</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// Validate template</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">isValid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">validateTemplate</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">isValid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;Template validation failed&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>

<span class="w">      </span><span class="c1">// Process template</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">promptText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">processTemplate</span><span class="p">(</span>
<span class="w">        </span><span class="nx">template</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="nx">context</span><span class="p">.</span><span class="nx">parameters</span>
<span class="w">      </span><span class="p">);</span>

<span class="w">      </span><span class="c1">// Execute prompt</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">completion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">openai</span><span class="p">.</span><span class="nx">chat</span><span class="p">.</span><span class="nx">completions</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">        </span><span class="nx">model</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">messages</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">promptText</span><span class="w"> </span><span class="p">}],</span>
<span class="w">        </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kt">context.userId</span><span class="p">,</span>
<span class="w">      </span><span class="p">});</span>

<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">PromptExecutionResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">executionId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">templateId</span><span class="o">:</span><span class="w"> </span><span class="kt">context.templateId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="kt">context.parameters</span><span class="p">,</span>
<span class="w">        </span><span class="nx">output</span><span class="o">:</span><span class="w"> </span><span class="kt">completion.choices</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">message</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
<span class="w">        </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">executionTime</span><span class="o">:</span><span class="w"> </span><span class="kt">Date.now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startTime</span><span class="p">,</span>
<span class="w">        </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">        </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">modelVersion</span><span class="o">:</span><span class="w"> </span><span class="kt">completion.model</span><span class="p">,</span>
<span class="w">          </span><span class="nx">promptTokens</span><span class="o">:</span><span class="w"> </span><span class="kt">completion.usage?.prompt_tokens</span><span class="p">,</span>
<span class="w">          </span><span class="nx">completionTokens</span><span class="o">:</span><span class="w"> </span><span class="kt">completion.usage?.completion_tokens</span><span class="p">,</span>
<span class="w">          </span><span class="nx">totalTokens</span><span class="o">:</span><span class="w"> </span><span class="kt">completion.usage?.total_tokens</span><span class="p">,</span>
<span class="w">          </span><span class="nx">processingSteps</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;template_fetch&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;validation&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;processing&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;execution&quot;</span><span class="p">],</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="c1">// Log execution</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">PromptDatabase</span><span class="p">.</span><span class="nx">logExecution</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">PromptExecutionResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">executionId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">templateId</span><span class="o">:</span><span class="w"> </span><span class="kt">context.templateId</span><span class="p">,</span>
<span class="w">        </span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="kt">context.parameters</span><span class="p">,</span>
<span class="w">        </span><span class="nx">output</span><span class="o">:</span><span class="w"> </span><span class="kt">null</span><span class="p">,</span>
<span class="w">        </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">executionTime</span><span class="o">:</span><span class="w"> </span><span class="kt">Date.now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startTime</span><span class="p">,</span>
<span class="w">        </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">        </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="kt">error.code</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;EXECUTION_ERROR&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">error.message</span><span class="p">,</span>
<span class="w">          </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">error.details</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">processingSteps</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;template_fetch&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;error&quot;</span><span class="p">],</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">      </span><span class="p">};</span>

<span class="w">      </span><span class="c1">// Log failed execution</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">PromptDatabase</span><span class="p">.</span><span class="nx">logExecution</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>

<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h3>promptExecutor.ts</h3><div class="highlight"><pre><span></span><span class="c1">// @ts-expect-error Val Town import</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">getTemplate</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;https://esm.town/v/@username/promptLibrary&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">OpenAI</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;npm:openai&quot;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">executePrompt</span><span class="p">(</span>
<span class="w">  </span><span class="nx">templateId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">any</span><span class="o">&gt;</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">PromptExecutionResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getTemplate</span><span class="p">(</span><span class="nx">templateId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">template</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Template </span><span class="si">${</span><span class="nx">templateId</span><span class="si">}</span><span class="sb"> not found`</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Validate parameters</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">required</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">template</span><span class="p">.</span><span class="nx">parameters</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">required</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nx">parameters</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Missing required parameter: </span><span class="si">${</span><span class="nx">required</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Replace parameters in template</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">promptText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">template</span><span class="p">.</span><span class="nx">template</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">parameters</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">promptText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">promptText</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sb">`\${</span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">}`</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="p">(</span><span class="nx">value</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Execute prompt using OpenAI</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">openai</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">OpenAI</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">completion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">chat</span><span class="p">.</span><span class="nx">completions</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">      </span><span class="nx">messages</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">promptText</span><span class="w"> </span><span class="p">}],</span>
<span class="w">      </span><span class="nx">model</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">templateId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="kt">parameters</span><span class="p">,</span>
<span class="w">      </span><span class="nx">output</span><span class="o">:</span><span class="w"> </span><span class="kt">completion.choices</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">message</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">executionTime</span><span class="o">:</span><span class="w"> </span><span class="kt">Date.now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startTime</span><span class="p">,</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">templateId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="kt">parameters</span><span class="p">,</span>
<span class="w">      </span><span class="nx">output</span><span class="o">:</span><span class="w"> </span><span class="kt">null</span><span class="p">,</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">executionTime</span><span class="o">:</span><span class="w"> </span><span class="kt">Date.now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startTime</span><span class="p">,</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">error.message</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h3>promptLibrary.ts</h3><div class="highlight"><pre><span></span><span class="c1">// @ts-expect-error Val Town import</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sqlite</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;https://esm.town/v/std/sqlite&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">drizzle</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;npm:drizzle-orm/libsql&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sqliteTable</span><span class="p">,</span><span class="w"> </span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">integer</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;npm:drizzle-orm/sqlite-core&quot;</span><span class="p">;</span>

<span class="c1">// Define the database schema</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">templates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sqliteTable</span><span class="p">(</span><span class="s2">&quot;prompt_templates&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">).</span><span class="nx">primaryKey</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;version&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;template&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;parameters&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span><span class="w"> </span><span class="c1">// JSON string</span>
<span class="w">  </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">author</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;author&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">lastUpdated</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;lastUpdated&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">text</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">).</span><span class="nx">notNull</span><span class="p">(),</span><span class="w"> </span><span class="c1">// JSON string</span>
<span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">drizzle</span><span class="p">(</span><span class="nx">sqlite</span><span class="p">);</span>

<span class="c1">// Main prompt library functions</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">createTemplate</span><span class="p">(</span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">PromptTemplate</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nx">template</span><span class="p">.</span><span class="nx">category</span><span class="si">}</span><span class="sb">_</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">insert</span><span class="p">(</span><span class="nx">templates</span><span class="p">).</span><span class="nx">values</span><span class="p">({</span>
<span class="w">    </span><span class="nx">id</span><span class="p">,</span>
<span class="w">    </span><span class="p">...</span><span class="nx">template</span><span class="p">,</span>
<span class="w">    </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">parameters</span><span class="p">),</span>
<span class="w">    </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">metadata</span><span class="p">),</span>
<span class="w">  </span><span class="p">});</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getTemplate</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">select</span><span class="p">().</span><span class="kr">from</span><span class="p">(</span><span class="nx">templates</span><span class="p">).</span><span class="nx">where</span><span class="p">({</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="p">}).</span><span class="nx">get</span><span class="p">();</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span><span class="nx">result</span><span class="p">,</span>
<span class="w">    </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">parameters</span><span class="p">),</span>
<span class="w">    </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">metadata</span><span class="p">),</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">listTemplates</span><span class="p">(</span><span class="nx">category?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">select</span><span class="p">().</span><span class="kr">from</span><span class="p">(</span><span class="nx">templates</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">category</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">query</span><span class="p">.</span><span class="nx">where</span><span class="p">({</span><span class="w"> </span><span class="nx">category</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">query</span><span class="p">.</span><span class="nx">all</span><span class="p">();</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">result</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">    </span><span class="p">...</span><span class="nx">result</span><span class="p">,</span>
<span class="w">    </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">parameters</span><span class="p">),</span>
<span class="w">    </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">metadata</span><span class="p">),</span>
<span class="w">  </span><span class="p">}));</span>
<span class="p">}</span>
</pre></div>
<h3>promptManager.ts</h3><div class="highlight"><pre><span></span><span class="c1">// HTTP val for managing prompts</span>
<span class="c1">// @ts-expect-error Val Town import</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createTemplate</span><span class="p">,</span><span class="w"> </span><span class="nx">listTemplates</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;https://esm.town/v/@username/promptLibrary&quot;</span><span class="p">;</span>
<span class="c1">// @ts-expect-error Val Town import</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">executePrompt</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;https://esm.town/v/@username/promptExecutor&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Hono</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;npm:hono&quot;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Hono</span><span class="p">();</span>

<span class="c1">// List all templates or by category</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/templates/:category?&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">category</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">templates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">listTemplates</span><span class="p">(</span><span class="nx">category</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">templates</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Create a new template</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/templates&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">createTemplate</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="p">});</span>
<span class="p">});</span>

<span class="c1">// Execute a prompt</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/execute/:templateId&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">templateId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s2">&quot;templateId&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">parameters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">executePrompt</span><span class="p">(</span><span class="nx">templateId</span><span class="p">,</span><span class="w"> </span><span class="nx">parameters</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">app</span><span class="p">;</span>
</pre></div>
<h3>prompt_chain_validator.ts</h3><div class="highlight"><pre><span></span><span class="kd">interface</span><span class="w"> </span><span class="nx">PromptResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;success&#39;</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">;</span>
<span class="w">  </span><span class="nx">validation</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">isComplete</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">missingFields</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<span class="w">    </span><span class="nx">formatErrors</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">PromptChainValidator</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="nx">validateInitialAnalysis</span><span class="p">(</span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">PromptResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">requiredFields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;purpose&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;components&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;data_flow&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;patterns&#39;</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">missingFields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">requiredFields</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">field</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="nx">response</span><span class="p">[</span><span class="nx">field</span><span class="p">]);</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">missingFields.length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;success&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1_initial_analysis&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="p">,</span>
<span class="w">      </span><span class="nx">validation</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">isComplete</span><span class="o">:</span><span class="w"> </span><span class="kt">missingFields.length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">missingFields</span><span class="p">,</span>
<span class="w">        </span><span class="nx">formatErrors</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="nx">validateComplexityAssessment</span><span class="p">(</span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">PromptResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">requiredFields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;complex_areas&#39;</span><span class="p">];</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">missingFields</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">requiredFields</span><span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">field</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="o">!</span><span class="nx">response</span><span class="p">[</span><span class="nx">field</span><span class="p">]);</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">status</span><span class="o">:</span><span class="w"> </span><span class="kt">missingFields.length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s1">&#39;success&#39;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;error&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;2_complexity_assessment&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="kt">response</span><span class="p">,</span>
<span class="w">      </span><span class="nx">validation</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">isComplete</span><span class="o">:</span><span class="w"> </span><span class="kt">missingFields.length</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">missingFields</span><span class="p">,</span>
<span class="w">        </span><span class="nx">formatErrors</span><span class="o">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">// Add similar validation methods for other stages...</span>

<span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="nx">validateChainResponse</span><span class="p">(</span><span class="nx">stage</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">response</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nx">PromptResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">switch</span><span class="p">(</span><span class="nx">stage</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;1_initial_analysis&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">validateInitialAnalysis</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
<span class="w">      </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;2_complexity_assessment&#39;</span><span class="o">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">validateComplexityAssessment</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
<span class="w">      </span><span class="c1">// Add other cases...</span>
<span class="w">      </span><span class="nx">default</span><span class="o">:</span>
<span class="w">        </span><span class="kt">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Unknown stage: </span><span class="si">${</span><span class="nx">stage</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PromptChainValidator</span><span class="p">,</span><span class="w"> </span><span class="nx">PromptResponse</span><span class="w"> </span><span class="p">};</span>
</pre></div>
<h3>prompt_executor.ts</h3><div class="highlight"><pre><span></span><span class="kd">interface</span><span class="w"> </span><span class="nx">PromptResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">promptName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">;</span>
<span class="w">  </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">executionTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="kd">class</span><span class="w"> </span><span class="nx">PromptExecutor</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">library</span><span class="o">:</span><span class="w"> </span><span class="kt">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">any</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">results</span><span class="o">:</span><span class="w"> </span><span class="kt">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">PromptResult</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">  </span><span class="kr">constructor</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">();</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">loadPromptLibrary</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">loadPromptLibrary</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Load prompts from YAML configuration</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">executePrompt</span><span class="p">(</span>
<span class="w">    </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">promptName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span>
<span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">PromptResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">prompt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">library</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">category</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">promptName</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">prompt</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Prompt </span><span class="si">${</span><span class="nx">category</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">promptName</span><span class="si">}</span><span class="sb"> not found`</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">processPrompt</span><span class="p">(</span><span class="nx">prompt</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="p">);</span>
<span class="w">    </span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">promptResult</span><span class="o">:</span><span class="w"> </span><span class="kt">PromptResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">category</span><span class="p">,</span>
<span class="w">      </span><span class="nx">promptName</span><span class="p">,</span>
<span class="w">      </span><span class="nx">result</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">executionTime</span><span class="o">:</span><span class="w"> </span><span class="kt">Date.now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startTime</span><span class="p">,</span>
<span class="w">        </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;1.0&#39;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">category</span><span class="si">}</span><span class="sb">.</span><span class="si">${</span><span class="nx">promptName</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span><span class="w"> </span><span class="nx">promptResult</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">promptResult</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">processPrompt</span><span class="p">(</span><span class="nx">prompt</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Implement prompt processing logic</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">getResults</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Map</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">PromptResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Map</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">results</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h3>prompt_library_types.ts</h3><div class="highlight"><pre><span></span><span class="c1">// Types for our prompt library system</span>
<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">PromptTemplate</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
</pre></div>
<h3>types.ts</h3><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Core types for the prompt library system</span>
<span class="cm"> * Last Updated: 2025-02-08 11:02:29</span>
<span class="cm"> * @author Toowiredd</span>
<span class="cm"> */</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;npm:zod&quot;</span><span class="p">;</span>

<span class="c1">// Zod schema for type validation</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">PromptTemplateSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="kt">z.array</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="kt">string</span><span class="p">()),</span>
<span class="w">  </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">author</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">lastUpdated</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">datetime</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">z.object</span><span class="p">({</span>
<span class="w">    </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="kt">z.array</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="kt">string</span><span class="p">()),</span>
<span class="w">    </span><span class="nx">complexity</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mf">10</span><span class="p">),</span>
<span class="w">    </span><span class="nx">expectedResponseFormat</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">requiredApiVersion</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">contextSize</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">  </span><span class="p">}),</span>
<span class="p">});</span>

<span class="c1">// Type inference from Zod schema</span>
<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">PromptTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">infer</span><span class="o">&lt;</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">PromptTemplateSchema</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">PromptExecutionContext</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">templateId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">requestId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">metadata?</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">PromptExecutionResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">templateId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">output</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="p">;</span>
<span class="w">  </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">  </span><span class="nx">executionTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">  </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">error</span><span class="o">?:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">details?</span><span class="o">:</span><span class="w"> </span><span class="kt">unknown</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">modelVersion?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">promptTokens?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">completionTokens?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">totalTokens?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">processingSteps?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">ValidationResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">valid</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">  </span><span class="nx">errors?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[];</span>
<span class="p">};</span>
</pre></div>
<h3>api.ts</h3><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * HTTP API endpoints for prompt library</span>
<span class="cm"> * Created: 2025-02-08 11:06:48 UTC</span>
<span class="cm"> * Author: @toowired</span>
<span class="cm"> */</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Hono</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;npm:hono&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">cors</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;npm:hono/cors&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">  </span><span class="nx">PromptTemplateSchema</span><span class="p">,</span>
<span class="w">  </span><span class="nx">ExecutionContextSchema</span><span class="w"> </span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;https://esm.town/v/@toowired/types&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">  </span><span class="nx">createTemplate</span><span class="p">,</span>
<span class="w">  </span><span class="nx">getTemplate</span><span class="p">,</span>
<span class="w">  </span><span class="nx">getExecutionHistory</span><span class="w"> </span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;https://esm.town/v/@toowired/db&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">executePrompt</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;https://esm.town/v/@toowired/executor&quot;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Hono</span><span class="p">();</span>

<span class="c1">// Middleware</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">cors</span><span class="p">());</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">next</span><span class="p">();</span>
<span class="w">  </span><span class="nx">c</span><span class="p">.</span><span class="nx">header</span><span class="p">(</span><span class="s1">&#39;X-Response-Time&#39;</span><span class="p">,</span><span class="w"> </span><span class="sb">`</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startTime</span><span class="si">}</span><span class="sb">ms`</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Error handler</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">onError</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">`[</span><span class="si">${</span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">()</span><span class="si">}</span><span class="sb">] Error:`</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="kt">err.code</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;INTERNAL_ERROR&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">err.message</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">  </span><span class="p">},</span><span class="w"> </span><span class="mf">500</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Create new template</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/templates&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">PromptTemplateSchema</span><span class="p">.</span><span class="nx">parseAsync</span><span class="p">({</span>
<span class="w">      </span><span class="p">...</span><span class="nx">body</span><span class="p">,</span>
<span class="w">      </span><span class="nx">author</span><span class="o">:</span><span class="w"> </span><span class="kt">body.author</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;@toowired&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">lastUpdated</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">createTemplate</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="mf">201</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;VALIDATION_ERROR&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Invalid template format&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">error.errors</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">400</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">});</span>

<span class="c1">// Get template</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/templates/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getTemplate</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">template</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;NOT_FOUND&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="sb">`Template </span><span class="si">${</span><span class="nx">id</span><span class="si">}</span><span class="sb"> not found`</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mf">404</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Execute prompt</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">&quot;/execute/:templateId&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">templateId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s2">&quot;templateId&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">req</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="w">  </span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">templateId</span><span class="p">,</span>
<span class="w">    </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="kt">body.parameters</span><span class="p">,</span>
<span class="w">    </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">requestId</span><span class="o">:</span><span class="w"> </span><span class="kt">c.req.headers.get</span><span class="p">(</span><span class="s2">&quot;x-request-id&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="sb">`req_</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">    </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">c.req.headers.get</span><span class="p">(</span><span class="s2">&quot;x-user-id&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;anonymous&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">body.metadata</span><span class="p">,</span>
<span class="w">  </span><span class="p">};</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">executePrompt</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
<span class="p">});</span>

<span class="c1">// Get execution history</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/executions/:templateId&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="p">(</span><span class="nx">c</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">templateId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s2">&quot;templateId&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s2">&quot;limit&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;10&quot;</span><span class="p">);</span>
<span class="w">  </span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">executions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getExecutionHistory</span><span class="p">(</span><span class="nx">templateId</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">json</span><span class="p">({</span><span class="w"> </span><span class="nx">executions</span><span class="w"> </span><span class="p">});</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">app</span><span class="p">;</span>
</pre></div>
<h3>examples.ts</h3><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Example usage of prompt library</span>
<span class="cm"> * Created: 2025-02-08 11:06:48 UTC</span>
<span class="cm"> * Author: @toowired</span>
<span class="cm"> */</span>

<span class="c1">// Example template creation</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">createCodeReviewTemplate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s2">&quot;https://api.val.town/v1/@toowired/api/templates&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;Content-Type&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;application/json&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<span class="w">      </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Comprehensive code review prompt with security and performance focus&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="sb">`Review this code:</span>

<span class="si">${</span><span class="nx">code</span><span class="si">}</span>

<span class="sb">Focus on the following aspects:</span>
<span class="si">${</span><span class="nx">aspects</span><span class="si">}</span>

<span class="sb">Please provide your review in the following format:</span>
<span class="sb">1. Security Issues</span>
<span class="sb">2. Performance Concerns</span>
<span class="sb">3. Code Quality</span>
<span class="sb">4. Best Practices</span>
<span class="sb">5. Suggested Improvements`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;aspects&quot;</span><span class="p">],</span>
<span class="w">      </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;code-review&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;review&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;security&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;performance&quot;</span><span class="p">],</span>
<span class="w">        </span><span class="nx">complexity</span><span class="o">:</span><span class="w"> </span><span class="kt">4</span><span class="p">,</span>
<span class="w">        </span><span class="nx">expectedResponseFormat</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;markdown&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">engine</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">contextSize</span><span class="o">:</span><span class="w"> </span><span class="kt">8192</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// Example prompt execution</span>
<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">executeCodeReview</span><span class="p">(</span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">fetch</span><span class="p">(</span><span class="s2">&quot;https://api.val.town/v1/@toowired/api/execute/tmpl_codereview&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;Content-Type&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;x-request-id&quot;</span><span class="o">:</span><span class="w"> </span><span class="sb">`req_</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;x-user-id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;@toowired&quot;</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.stringify</span><span class="p">({</span>
<span class="w">      </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">code</span><span class="p">,</span>
<span class="w">        </span><span class="nx">aspects</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;security, performance, maintainability, error handling&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">codeLanguage</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;typescript&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">requestOrigin</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;example&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
<h3>executor.ts</h3><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Prompt execution engine</span>
<span class="cm"> * Created: 2025-02-08 11:06:48 UTC</span>
<span class="cm"> * Author: @toowired</span>
<span class="cm"> */</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">OpenAI</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;npm:openai&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">  </span><span class="nx">PromptTemplate</span><span class="p">,</span>
<span class="w">  </span><span class="nx">PromptExecutionContext</span><span class="p">,</span>
<span class="w">  </span><span class="nx">PromptExecutionResult</span><span class="p">,</span>
<span class="w">  </span><span class="nx">ExecutionContextSchema</span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;https://esm.town/v/@toowired/types&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">  </span><span class="nx">getTemplate</span><span class="p">,</span>
<span class="w">  </span><span class="nx">logExecution</span><span class="w"> </span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;https://esm.town/v/@toowired/db&quot;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">openai</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">OpenAI</span><span class="p">({</span>
<span class="w">  </span><span class="nx">apiKey</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.OPENAI_API_KEY</span>
<span class="p">});</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">processTemplate</span><span class="p">(</span>
<span class="w">  </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">PromptTemplate</span><span class="p">,</span>
<span class="w">  </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="kt">Record</span><span class="o">&lt;</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">unknown</span><span class="o">&gt;</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">processedTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">template</span><span class="p">.</span><span class="nx">template</span><span class="p">;</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="p">[</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">entries</span><span class="p">(</span><span class="nx">parameters</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">template</span><span class="p">.</span><span class="nx">parameters</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">key</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Unknown parameter: </span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">processedTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">processedTemplate</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span>
<span class="w">      </span><span class="sb">`\${</span><span class="si">${</span><span class="nx">key</span><span class="si">}</span><span class="sb">}`</span><span class="p">,</span>
<span class="w">      </span><span class="nb">String</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
<span class="w">    </span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">processedTemplate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">executePrompt</span><span class="p">(</span>
<span class="w">  </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="kt">PromptExecutionContext</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">PromptExecutionResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">startTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">executionId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`exec_</span><span class="si">${</span><span class="nx">context</span><span class="p">.</span><span class="nx">requestId</span><span class="si">}</span><span class="sb">_</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>

<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Validate context</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">ExecutionContextSchema</span><span class="p">.</span><span class="nx">parseAsync</span><span class="p">(</span><span class="nx">context</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Fetch template</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">template</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">getTemplate</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">templateId</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">template</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`Template </span><span class="si">${</span><span class="nx">context</span><span class="p">.</span><span class="nx">templateId</span><span class="si">}</span><span class="sb"> not found`</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Process template</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">promptText</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">processTemplate</span><span class="p">(</span><span class="nx">template</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">parameters</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// Execute prompt</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">completion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">chat</span><span class="p">.</span><span class="nx">completions</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">      </span><span class="nx">model</span><span class="o">:</span><span class="w"> </span><span class="kt">template.metadata.engine</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;gpt-4&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="nx">messages</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="w"> </span><span class="nx">role</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="kt">promptText</span><span class="w"> </span><span class="p">}],</span>
<span class="w">      </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="kt">context.userId</span><span class="p">,</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">PromptExecutionResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">executionId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">templateId</span><span class="o">:</span><span class="w"> </span><span class="kt">context.templateId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="kt">context.parameters</span><span class="p">,</span>
<span class="w">      </span><span class="nx">output</span><span class="o">:</span><span class="w"> </span><span class="kt">completion.choices</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">message</span><span class="p">.</span><span class="nx">content</span><span class="p">,</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">executionTime</span><span class="o">:</span><span class="w"> </span><span class="kt">Date.now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startTime</span><span class="p">,</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">modelVersion</span><span class="o">:</span><span class="w"> </span><span class="kt">completion.model</span><span class="p">,</span>
<span class="w">        </span><span class="nx">promptTokens</span><span class="o">:</span><span class="w"> </span><span class="kt">completion.usage?.prompt_tokens</span><span class="p">,</span>
<span class="w">        </span><span class="nx">completionTokens</span><span class="o">:</span><span class="w"> </span><span class="kt">completion.usage?.completion_tokens</span><span class="p">,</span>
<span class="w">        </span><span class="nx">totalTokens</span><span class="o">:</span><span class="w"> </span><span class="kt">completion.usage?.total_tokens</span><span class="p">,</span>
<span class="w">        </span><span class="nx">processingSteps</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;validation&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;template_fetch&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;processing&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;execution&quot;</span><span class="p">],</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Log execution</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">logExecution</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>

<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">PromptExecutionResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">executionId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">templateId</span><span class="o">:</span><span class="w"> </span><span class="kt">context.templateId</span><span class="p">,</span>
<span class="w">      </span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="kt">context.parameters</span><span class="p">,</span>
<span class="w">      </span><span class="nx">output</span><span class="o">:</span><span class="w"> </span><span class="kt">null</span><span class="p">,</span>
<span class="w">      </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">().</span><span class="nx">toISOString</span><span class="p">(),</span>
<span class="w">      </span><span class="nx">executionTime</span><span class="o">:</span><span class="w"> </span><span class="kt">Date.now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">startTime</span><span class="p">,</span>
<span class="w">      </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">false</span><span class="p">,</span>
<span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="kt">error.code</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">&quot;EXECUTION_ERROR&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">error.message</span><span class="p">,</span>
<span class="w">        </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">error</span><span class="p">,</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">processingSteps</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">],</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">logExecution</span><span class="p">(</span><span class="nx">result</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">result</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h3>pwa-config.ts</h3><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * PWA Configuration</span>
<span class="cm"> * Created: 2025-02-08 11:08:42 UTC</span>
<span class="cm"> * Author: @toowired</span>
<span class="cm"> */</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">VitePWA</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;npm:vite-plugin-pwa&#39;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">pwaConfig</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">registerType</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;autoUpdate&#39;</span><span class="p">,</span>
<span class="w">  </span><span class="nx">manifest</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Prompt Library&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">short_name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;PromptLib&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;AI Prompt Management System&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">theme_color</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;#2196f3&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">background_color</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;#ffffff&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">display</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;standalone&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">orientation</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;portrait&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">scope</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">start_url</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">icons</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">src</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;icons/icon-72x72.png&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sizes</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;72x72&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;image/png&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">src</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;icons/icon-96x96.png&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sizes</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;96x96&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;image/png&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">src</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;icons/icon-128x128.png&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sizes</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;128x128&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;image/png&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">src</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;icons/icon-144x144.png&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sizes</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;144x144&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;image/png&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">src</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;icons/icon-152x152.png&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sizes</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;152x152&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;image/png&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">src</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;icons/icon-192x192.png&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sizes</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;192x192&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;image/png&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">purpose</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;any maskable&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">src</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;icons/icon-384x384.png&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sizes</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;384x384&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;image/png&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">src</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;icons/icon-512x512.png&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">sizes</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;512x512&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;image/png&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">workbox</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">globPatterns</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;**/*.{js,css,html,ico,png,svg,woff2}&#39;</span><span class="p">],</span>
<span class="w">    </span><span class="nx">runtimeCaching</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nx">urlPattern</span><span class="o">:</span><span class="w"> </span><span class="sr">/^https:\/\/api\.val\.town\/v1\/@toowired\/api/</span><span class="p">,</span>
<span class="w">        </span><span class="nx">handler</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;NetworkFirst&#39;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">options</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nx">cacheName</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;api-cache&#39;</span><span class="p">,</span>
<span class="w">          </span><span class="nx">expiration</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">maxEntries</span><span class="o">:</span><span class="w"> </span><span class="kt">50</span><span class="p">,</span>
<span class="w">            </span><span class="nx">maxAgeSeconds</span><span class="o">:</span><span class="w"> </span><span class="kt">60</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">60</span><span class="w"> </span><span class="c1">// 1 hour</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">devOptions</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">enabled</span><span class="o">:</span><span class="w"> </span><span class="kt">true</span><span class="p">,</span>
<span class="w">    </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;module&#39;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
<h3>index.html</h3><div class="highlight"><pre><span></span><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">lang</span><span class="o">=</span><span class="s">&quot;en&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;UTF-8&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span>Prompt Library<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;description&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;AI Prompt Management System&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;icon&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;image/png&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;/icons/icon-192x192.png&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;apple-touch-icon&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;/icons/icon-192x192.png&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;theme-color&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;#2196f3&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;manifest&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;/manifest.json&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="w">    </span><span class="nt">body</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">margin</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">      </span><span class="k">font-family</span><span class="p">:</span><span class="w"> </span><span class="n">system-ui</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">apple-system</span><span class="p">,</span><span class="w"> </span><span class="kc">sans-serif</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="o">*</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">box-sizing</span><span class="p">:</span><span class="w"> </span><span class="kc">border-box</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">&lt;/</span><span class="nt">style</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;root&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;module&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;/index.tsx&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</pre></div>
<h3>db.ts</h3><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Database operations for prompt library</span>
<span class="cm"> * Created: 2025-02-08 11:05:26 UTC</span>
<span class="cm"> * Author: @toowiredd</span>
<span class="cm"> */</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sqlite</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;https://esm.town/v/std/sqlite&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">PromptTemplate</span><span class="p">,</span><span class="w"> </span><span class="nx">PromptExecutionResult</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;https://esm.town/v/@toowiredd/types&quot;</span><span class="p">;</span>

<span class="c1">// Initialize tables if they don&#39;t exist</span>
<span class="k">await</span><span class="w"> </span><span class="nx">sqlite</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="sb">`</span>
<span class="sb">  CREATE TABLE IF NOT EXISTS prompt_templates (</span>
<span class="sb">    id TEXT PRIMARY KEY,</span>
<span class="sb">    version TEXT NOT NULL,</span>
<span class="sb">    description TEXT NOT NULL,</span>
<span class="sb">    template TEXT NOT NULL,</span>
<span class="sb">    parameters TEXT NOT NULL,</span>
<span class="sb">    category TEXT NOT NULL,</span>
<span class="sb">    author TEXT NOT NULL,</span>
<span class="sb">    last_updated TEXT NOT NULL,</span>
<span class="sb">    metadata TEXT NOT NULL,</span>
<span class="sb">    created_at TEXT DEFAULT CURRENT_TIMESTAMP</span>
<span class="sb">  );</span>

<span class="sb">  CREATE TABLE IF NOT EXISTS prompt_executions (</span>
<span class="sb">    id TEXT PRIMARY KEY,</span>
<span class="sb">    template_id TEXT NOT NULL,</span>
<span class="sb">    input TEXT NOT NULL,</span>
<span class="sb">    output TEXT NOT NULL,</span>
<span class="sb">    timestamp TEXT NOT NULL,</span>
<span class="sb">    execution_time INTEGER NOT NULL,</span>
<span class="sb">    success INTEGER NOT NULL,</span>
<span class="sb">    error TEXT,</span>
<span class="sb">    metadata TEXT,</span>
<span class="sb">    FOREIGN KEY(template_id) REFERENCES prompt_templates(id)</span>
<span class="sb">  );</span>

<span class="sb">  CREATE INDEX IF NOT EXISTS idx_templates_category ON prompt_templates(category);</span>
<span class="sb">  CREATE INDEX IF NOT EXISTS idx_executions_template ON prompt_executions(template_id, timestamp);</span>
<span class="sb">`</span><span class="p">);</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">createTemplate</span><span class="p">(</span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">PromptTemplate</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`tmpl_</span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="si">}</span><span class="sb">_</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">().</span><span class="nx">toString</span><span class="p">(</span><span class="mf">36</span><span class="p">).</span><span class="nx">slice</span><span class="p">(</span><span class="mf">2</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">;</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">sqlite</span><span class="p">.</span><span class="nx">execute</span><span class="p">({</span>
<span class="w">    </span><span class="nx">sql</span><span class="o">:</span><span class="w"> </span><span class="sb">`INSERT INTO prompt_templates </span>
<span class="sb">          (id, version, description, template, parameters, category, author, last_updated, metadata)</span>
<span class="sb">          VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`</span><span class="p">,</span>
<span class="w">    </span><span class="nx">args</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="nx">id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">template</span><span class="p">.</span><span class="nx">version</span><span class="p">,</span>
<span class="w">      </span><span class="nx">template</span><span class="p">.</span><span class="nx">description</span><span class="p">,</span>
<span class="w">      </span><span class="nx">template</span><span class="p">.</span><span class="nx">template</span><span class="p">,</span>
<span class="w">      </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">parameters</span><span class="p">),</span>
<span class="w">      </span><span class="nx">template</span><span class="p">.</span><span class="nx">category</span><span class="p">,</span>
<span class="w">      </span><span class="nx">template</span><span class="p">.</span><span class="nx">author</span><span class="p">,</span>
<span class="w">      </span><span class="nx">template</span><span class="p">.</span><span class="nx">lastUpdated</span><span class="p">,</span>
<span class="w">      </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">metadata</span><span class="p">),</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getTemplate</span><span class="p">(</span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">PromptTemplate</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kc">null</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">sqlite</span><span class="p">.</span><span class="nx">execute</span><span class="p">({</span>
<span class="w">    </span><span class="nx">sql</span><span class="o">:</span><span class="w"> </span><span class="sb">`SELECT * FROM prompt_templates WHERE id = ?`</span><span class="p">,</span>
<span class="w">    </span><span class="nx">args</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">id</span><span class="p">],</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">.</span><span class="nx">rows</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">rows</span><span class="p">[</span><span class="mf">0</span><span class="p">];</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span><span class="nx">row</span><span class="p">,</span>
<span class="w">    </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">parameters</span><span class="p">),</span>
<span class="w">    </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">metadata</span><span class="p">),</span>
<span class="w">  </span><span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">logExecution</span><span class="p">(</span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">PromptExecutionResult</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">sqlite</span><span class="p">.</span><span class="nx">execute</span><span class="p">({</span>
<span class="w">    </span><span class="nx">sql</span><span class="o">:</span><span class="w"> </span><span class="sb">`INSERT INTO prompt_executions </span>
<span class="sb">          (id, template_id, input, output, timestamp, execution_time, success, error, metadata)</span>
<span class="sb">          VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`</span><span class="p">,</span>
<span class="w">    </span><span class="nx">args</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">templateId</span><span class="p">,</span>
<span class="w">      </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">input</span><span class="p">),</span>
<span class="w">      </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">output</span><span class="p">),</span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">,</span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">executionTime</span><span class="p">,</span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">success</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span>
<span class="w">      </span><span class="nx">result</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">      </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">metadata</span><span class="p">),</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>

<span class="k">export</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">getExecutionHistory</span><span class="p">(</span>
<span class="w">  </span><span class="nx">templateId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">  </span><span class="nx">limit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10</span>
<span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">PromptExecutionResult</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">sqlite</span><span class="p">.</span><span class="nx">execute</span><span class="p">({</span>
<span class="w">    </span><span class="nx">sql</span><span class="o">:</span><span class="w"> </span><span class="sb">`SELECT * FROM prompt_executions </span>
<span class="sb">          WHERE template_id = ? </span>
<span class="sb">          ORDER BY timestamp DESC </span>
<span class="sb">          LIMIT ?`</span><span class="p">,</span>
<span class="w">    </span><span class="nx">args</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">templateId</span><span class="p">,</span><span class="w"> </span><span class="nx">limit</span><span class="p">],</span>
<span class="w">  </span><span class="p">});</span>

<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">rows</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">row</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">({</span>
<span class="w">    </span><span class="p">...</span><span class="nx">row</span><span class="p">,</span>
<span class="w">    </span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">input</span><span class="p">),</span>
<span class="w">    </span><span class="nx">output</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">output</span><span class="p">),</span>
<span class="w">    </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">row.error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kc">undefined</span><span class="p">,</span>
<span class="w">    </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">JSON.parse</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">metadata</span><span class="p">),</span>
<span class="w">    </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">Boolean</span><span class="p">(</span><span class="nx">row</span><span class="p">.</span><span class="nx">success</span><span class="p">),</span>
<span class="w">  </span><span class="p">}));</span>
<span class="p">}</span>
</pre></div>
<h3>executor.ts</h3><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Prompt execution engine</span>
<span class="cm"> * Created: 2025-02-08 11:05:26 UTC</span>
<span class="cm"> * Author: @toowiredd</span>
<span class="cm"> */</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">OpenAI</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;npm:openai&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">  </span><span class="nx">PromptTemplate</span><span class="p">,</span>
<span class="w">  </span><span class="nx">PromptExecutionContext</span><span class="p">,</span>
<span class="w">  </span><span class="nx">PromptExecutionResult</span><span class="p">,</span>
<span class="w">  </span><span class="nx">ExecutionContextSchema</span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;https://esm.town/v/@toowiredd/types&quot;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">  </span><span class="nx">getTemplate</span><span class="p">,</span>
<span class="w">  </span><span class="nx">logExecution</span><span class="w"> </span>
<span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;https://esm.town/v/@toowiredd/db&quot;</span><span class="p">;</span>

<span class="c1">// Initialize OpenAI client</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">openai</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">OpenA</span>
</pre></div>
<h3>types.ts</h3><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Shared types for the prompt library system</span>
<span class="cm"> * Created: 2025-02-08 11:05:26 UTC</span>
<span class="cm"> * Author: @toowiredd</span>
<span class="cm"> */</span>

<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;npm:zod&quot;</span><span class="p">;</span>

<span class="c1">// Schema for prompt templates with strict validation</span>
<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">PromptTemplateSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">regex</span><span class="p">(</span><span class="sr">/^\d+\.\d+\.\d+$/</span><span class="p">),</span>
<span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">10</span><span class="p">),</span>
<span class="w">  </span><span class="nx">template</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">),</span>
<span class="w">  </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="kt">z.array</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="kt">string</span><span class="p">()),</span>
<span class="w">  </span><span class="nx">category</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">author</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">lastUpdated</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">datetime</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">z.object</span><span class="p">({</span>
<span class="w">    </span><span class="nx">tags</span><span class="o">:</span><span class="w"> </span><span class="kt">z.array</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="kt">string</span><span class="p">()),</span>
<span class="w">    </span><span class="nx">complexity</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="kr">int</span><span class="p">().</span><span class="nx">min</span><span class="p">(</span><span class="mf">1</span><span class="p">).</span><span class="nx">max</span><span class="p">(</span><span class="mf">10</span><span class="p">),</span>
<span class="w">    </span><span class="nx">expectedResponseFormat</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">requiredApiVersion</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">contextSize</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">engine</span><span class="o">:</span><span class="w"> </span><span class="kt">z.enum</span><span class="p">([</span><span class="s1">&#39;gpt-4&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;gpt-3.5-turbo&#39;</span><span class="p">]).</span><span class="k">default</span><span class="p">(</span><span class="s1">&#39;gpt-4&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="p">}).</span><span class="nx">strict</span><span class="p">(),</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">PromptTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">infer</span><span class="o">&lt;</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">PromptTemplateSchema</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">ExecutionContextSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">templateId</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">parameters</span><span class="o">:</span><span class="w"> </span><span class="kt">z.record</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="nx">unknown</span><span class="p">()),</span>
<span class="w">  </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">datetime</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">requestId</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">userId</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">z.record</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="nx">unknown</span><span class="p">()).</span><span class="nx">optional</span><span class="p">(),</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">PromptExecutionContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">infer</span><span class="o">&lt;</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">ExecutionContextSchema</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">ExecutionResultSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">templateId</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="kt">z.record</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="nx">unknown</span><span class="p">()),</span>
<span class="w">  </span><span class="nx">output</span><span class="o">:</span><span class="w"> </span><span class="kt">z.unknown</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">datetime</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">executionTime</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">success</span><span class="o">:</span><span class="w"> </span><span class="kt">z.boolean</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">z.object</span><span class="p">({</span>
<span class="w">    </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">details</span><span class="o">:</span><span class="w"> </span><span class="kt">z.unknown</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">  </span><span class="p">}).</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">z.object</span><span class="p">({</span>
<span class="w">    </span><span class="nx">modelVersion</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">promptTokens</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">completionTokens</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">totalTokens</span><span class="o">:</span><span class="w"> </span><span class="kt">z.number</span><span class="p">().</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">processingSteps</span><span class="o">:</span><span class="w"> </span><span class="kt">z.array</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="kt">string</span><span class="p">()).</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">  </span><span class="p">}),</span>
<span class="p">});</span>

<span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">PromptExecutionResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">infer</span><span class="o">&lt;</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">ExecutionResultSchema</span><span class="o">&gt;</span><span class="p">;</span>
</pre></div>
<h3>check-timestamps.ts</h3><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">readFileSync</span><span class="p">,</span><span class="w"> </span><span class="nx">readdirSync</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;fs&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">join</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;path&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">TIMESTAMP_REGEX</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sr">/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">CURRENT_TIME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;2025-02-08 11:36:20&quot;</span><span class="p">;</span>

<span class="kd">function</span><span class="w"> </span><span class="nx">validateTimestamp</span><span class="p">(</span><span class="nx">timestamp</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">TIMESTAMP_REGEX</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">timestampDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">timestamp</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;T&#39;</span><span class="p">));</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">currentDate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Date</span><span class="p">(</span><span class="nx">CURRENT_TIME</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;T&#39;</span><span class="p">));</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="nx">timestampDate</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">currentDate</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">checkFile</span><span class="p">(</span><span class="nx">filePath</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf-8&#39;</span><span class="p">));</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">content</span><span class="p">.</span><span class="nx">created</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="nx">validateTimestamp</span><span class="p">(</span><span class="nx">content</span><span class="p">.</span><span class="nx">created</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">` Invalid timestamp in </span><span class="si">${</span><span class="nx">filePath</span><span class="si">}</span><span class="sb">: </span><span class="si">${</span><span class="nx">content</span><span class="p">.</span><span class="nx">created</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">` Valid timestamps in </span><span class="si">${</span><span class="nx">filePath</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">` Error checking </span><span class="si">${</span><span class="nx">filePath</span><span class="si">}</span><span class="sb">:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">configFiles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">...</span><span class="nx">readdirSync</span><span class="p">(</span><span class="s1">&#39;./vals&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;./vals&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">f</span><span class="p">)),</span>
<span class="w">    </span><span class="p">...</span><span class="nx">readdirSync</span><span class="p">(</span><span class="s1">&#39;./docs&#39;</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;./docs&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">f</span><span class="p">))</span>
<span class="w">  </span><span class="p">].</span><span class="nx">filter</span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">));</span>
<span class="w">  </span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">configFiles</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">checkFile</span><span class="p">));</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">results</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">main</span><span class="p">().</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
</pre></div>
<h3>config.ts</h3><div class="highlight"><pre><span></span><span class="k">export</span><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">CONFIG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">valtown</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">namespace</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;@toowired&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">apiKeyEnv</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;VAL_TOWN_API_KEY&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">privacy</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;public&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">initialization</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">files</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="s2">&quot;prompt-types.json&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prompt-store.json&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prompt-executor.json&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prompt-api.json&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prompt-sync.json&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prompt-cache.json&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prompt-suggestions.json&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prompt-testing.json&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prompt-docs.json&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prompt-workflows.json&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prompt-search.json&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prompt-optimizer.json&quot;</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nx">order</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s2">&quot;prompt-types.json&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prompt-store.json&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prompt-executor.json&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;prompt-api.json&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">4</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<h3>init.ts</h3><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">ValTown</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;@val-town/api&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">readFileSync</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;fs&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">join</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;path&#39;</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">valtown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ValTown</span><span class="p">({</span>
<span class="w">  </span><span class="nx">apiKey</span><span class="o">:</span><span class="w"> </span><span class="kt">process.env.VAL_TOWN_API_KEY</span>
<span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">VALS_DIR</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;..&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;vals&#39;</span><span class="p">);</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">createVal</span><span class="p">(</span><span class="nx">filename</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">join</span><span class="p">(</span><span class="nx">VALS_DIR</span><span class="p">,</span><span class="w"> </span><span class="nx">filename</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;utf-8&#39;</span><span class="p">));</span>
<span class="w">  </span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">valtown</span><span class="p">.</span><span class="nx">vals</span><span class="p">.</span><span class="nx">create</span><span class="p">({</span>
<span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">content.name</span><span class="p">,</span>
<span class="w">      </span><span class="nx">code</span><span class="o">:</span><span class="w"> </span><span class="sb">`export const </span><span class="si">${</span><span class="nx">content</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="mf">1</span><span class="p">]</span><span class="si">}</span><span class="sb"> = </span><span class="si">${</span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">content</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="si">}</span><span class="sb">`</span><span class="p">,</span>
<span class="w">      </span><span class="nx">privacy</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;public&#39;</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">` Created val: </span><span class="si">${</span><span class="nx">content</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">` Failed to create val </span><span class="si">${</span><span class="nx">content</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">vals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="s1">&#39;prompt-types.json&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;prompt-store.json&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;prompt-executor.json&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;prompt-api.json&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;prompt-sync.json&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;prompt-cache.json&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;prompt-suggestions.json&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;prompt-testing.json&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;prompt-docs.json&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;prompt-workflows.json&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;prompt-search.json&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;prompt-optimizer.json&#39;</span>
<span class="w">  </span><span class="p">];</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">val</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">vals</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nx">createVal</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">main</span><span class="p">().</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
</pre></div>
<h3>validate-config.ts</h3><div class="highlight"><pre><span></span><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">z</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;zod&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">readFileSync</span><span class="p">,</span><span class="w"> </span><span class="nx">readdirSync</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;fs&#39;</span><span class="p">;</span>
<span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">join</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s1">&#39;path&#39;</span><span class="p">;</span>

<span class="c1">// Schema definitions</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">AuthorSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">github</span><span class="o">:</span><span class="w"> </span><span class="kt">z.literal</span><span class="p">(</span><span class="s1">&#39;toowiredd&#39;</span><span class="p">),</span>
<span class="w">  </span><span class="nx">valtown</span><span class="o">:</span><span class="w"> </span><span class="kt">z.literal</span><span class="p">(</span><span class="s1">&#39;toowired&#39;</span><span class="p">)</span>
<span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">TimestampSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="kt">string</span><span class="p">().</span><span class="nx">regex</span><span class="p">(</span><span class="sr">/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/</span><span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">BaseConfigSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">version</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">created</span><span class="o">:</span><span class="w"> </span><span class="kt">TimestampSchema</span><span class="p">,</span>
<span class="w">  </span><span class="nx">author</span><span class="o">:</span><span class="w"> </span><span class="kt">AuthorSchema</span>
<span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">ValMethodSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">z</span><span class="p">.</span><span class="nx">object</span><span class="p">({</span>
<span class="w">  </span><span class="nx">input</span><span class="o">:</span><span class="w"> </span><span class="kt">z.record</span><span class="p">(</span><span class="nx">z</span><span class="p">.</span><span class="nx">any</span><span class="p">()).</span><span class="nx">optional</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">output</span><span class="o">:</span><span class="w"> </span><span class="kt">z.any</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">z.any</span><span class="p">().</span><span class="nx">optional</span><span class="p">()</span>
<span class="p">});</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">ValConfigSchema</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">BaseConfigSchema</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
<span class="w">  </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="kt">z.string</span><span class="p">(),</span>
<span class="w">  </span><span class="nx">methods</span><span class="o">:</span><span class="w"> </span><span class="kt">z.record</span><span class="p">(</span><span class="nx">ValMethodSchema</span><span class="p">)</span>
<span class="p">});</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">validateConfig</span><span class="p">(</span><span class="nx">filePath</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">boolean</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">filePath</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;utf-8&#39;</span><span class="p">));</span>
<span class="w">    </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">filePath</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;vals/&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">ValConfigSchema</span><span class="p">.</span><span class="nx">parseAsync</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">BaseConfigSchema</span><span class="p">.</span><span class="nx">parseAsync</span><span class="p">(</span><span class="nx">content</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">` Valid configuration: </span><span class="si">${</span><span class="nx">filePath</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="sb">` Invalid configuration in </span><span class="si">${</span><span class="nx">filePath</span><span class="si">}</span><span class="sb">:`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">configFiles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">readdirSync</span><span class="p">(</span><span class="s1">&#39;./vals&#39;</span><span class="p">).</span><span class="nx">filter</span><span class="p">(</span><span class="nx">f</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">));</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span>
<span class="w">    </span><span class="nx">configFiles</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">file</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">validateConfig</span><span class="p">(</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;./vals&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">file</span><span class="p">)))</span>
<span class="w">  </span><span class="p">);</span>
<span class="w">  </span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">results</span><span class="p">.</span><span class="nx">every</span><span class="p">(</span><span class="nb">Boolean</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">valid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mf">1</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">main</span><span class="p">().</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span>
</pre></div>
</body>
            </html>

        </body>
        </html>
